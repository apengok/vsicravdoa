{% extends 'dma/home.html' %}


{% block breadcrumbs %} / 企业管理/角色管理{% endblock %}

{% load staticfiles %}

{% block main_content %}
  <div class="row ">
    

    <div class="col-sm-12" style="margin-left: -10px;">
          

          <div class="ibox float-e-margins">
              <div class="ibox-title modal_head collapse-link" >
                <h5>角色列表 </h5>
                  <div class="ibox-tools" >
                      <a >
                          <i class="fa fa-angle-down"></i>
                      </a>
                      
                  </div>
                  
              </div>
              <div class="ibox-content">
                  
              
              
                    <div class="bars pull-left">
                      <div class="btn-group pull-left barsMargin" role="group">
                          <form role="form"> 
                             <label><input type="text" class="Inlinesearch form-control" id="simpleQueryParam" name="simpleQueryParam" placeholder="请输入角色名称"></label>
                              <button type="button" id="search_button"  class="btn btn-outline btn-default">搜索
                              </button>
                             <input id="hiddenText" type="text" style="display:none">
                          </form> 
                      </div>
                      <div class="dropdown pull-left">
                          <button class="btn btn-default dropdown-toggle"  data-toggle="dropdown" >操作菜单<span class="caret"></span>
                          </button>
                          <ul class="dropdown-menu" >
                              <li><a href="{% url 'dma:role_create_manager' %}" id="addId" data-toggle="modal" data-target="#commonSmWin"><i class="glyphicon glyphicon-plus icoPaddingLeft"></i>新增</a></li>
                              <li><a href="javascript:void(0);" id="del_model"><i class="glyphicon glyphicon-trash icoPaddingLeft"></i>批量删除</a></li>
                          </ul>
                      </div>

                      
                    </div>

                    
                    
                    <div>
                    <table id="tb_stations" class="ax_default table table-bordered">
                      <thead>
                        <tr>
                          
                          <th style="height: 51px;width: 51px;text-align: center;" >序号</th>
                          <th style="height: 51px;width: 51px;text-align: center;" >选择</th>
                          <th style="height: 51px;width: 164px;text-align: center;" >操作</th>
                          <th style="height: 51px;width: 240px;text-align: center;" >角色名称</th>
                          <th style="height: 51px;width: 500px;text-align: center;" >备注</th>
                          <th style="height: 51px;text-align: center;" >预览</th>
                          
                          
                        </tr>
        
                      </thead>
                     {% for r in role_list %}
                        <tr >
                          <td>{{ r.id }} </td>
                          <td><input type="checkbox"/> </td>
                          <td class="ax_default _查询按钮">
                            <div >
                              <a class="btn btn-default" href="{% url 'dma:role_edit_manager' r.id %}" data-toggle="modal" data-target="#commonSmWin" title="update stations" style="background-color: #169bd5;width: 60px;height: 35;">修改</a>
                              <a class="btn btn-default" id = "btnDelete" style="background-color: rgba(153, 153, 153, 1);width: 60px;height: 35;">删除</a>

                            </div>
                          </td>

                          
                
                          <td >{{ r.name }} </td>
                          <td>{{ r.notes }} </td>
                          <td>预览 </td>
                          
                          
                        </tr>
                        
                     {% endfor %}
                    </table>
                    <div class="row">
                      <div class="col-md-3 col-sm-12 col-xs-12">
                        <div class="dataTables_length" id="dataTable_length">
                          <label>每页 <select name="dataTable_length" aria-controls="dataTable" class=""><option value="10">10</option><option value="20">20</option><option value="50">50</option><option value="100">100</option><option value="200">200</option></select> 条记录</label>
                        </div>
                      </div>
                      <div class="col-md-4 col-sm-12 col-xs-12">
                        <div class="dataTables_info" id="dataTable_info" role="alert" aria-live="polite" aria-relevant="all">第 1 至 10 条记录，共 14 条</div>
                      </div>
                      <div class="col-md-5 col-sm-12 col-xs-12">
                        <div class="dataTables_paginate paging_full_numbers" id="dataTable_paginate">
                          <ul class="pagination">
                            <li class="paginate_button first disabled" aria-controls="dataTable" tabindex="0" id="dataTable_first"><a href="#">首页</a>
                            </li>
                            <li class="paginate_button previous disabled" aria-controls="dataTable" tabindex="0" id="dataTable_previous"><a href="#">上一页</a>
                            </li>
                            <li class="paginate_button active" aria-controls="dataTable" tabindex="0"><a href="#">1</a></li>
                            <li class="paginate_button next" aria-controls="dataTable" tabindex="0" id="dataTable_next"><a href="#">下一页</a></li>
                            <li class="paginate_button last" aria-controls="dataTable" tabindex="0" id="dataTable_last"><a href="#">末页</a>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>

                  </div>
                  

              </div>
          </div>
      
          
      </div> 


      <!-- teset -->
      <div class="row">
        <div class="col-md-12">
          <div class="panel panel-default">
            <div class="panel-heading" id="stretch" >
              <h3 class="panel-title fwb">角色列表</h3>
              <div class="actions pull-right">
                <i class="fa chevron-down"  id="stretch-chevron" ></i>
              </div>
            </div>
            <div class="panel-body fixed-table-body"  id="stretch-body">
            <input value="true" id="permission" type="hidden"  />
                        <div class="ToolPanel">
                            <div class="bars pull-left">
                                <div class="btn-group pull-left barsMargin" role="group">
                                    <form role="form"> 
                                       <label><input type="text" class="Inlinesearch form-control" id="simpleQueryParam" name="simpleQueryParam" placeholder="请输入角色名称"></label>
                                            <button type="button" id="search_button" onclick="myTable.requestData()"
                                                    class="btn btn-outline btn-default">搜索
                                            </button>
                                       <input id="hiddenText" type="text" style="display:none" />
                                    </form> 
                                </div>
                                <div class="dropdown pull-left">
                                    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">操作菜单<span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                        <li><a href="/clbs/c/role/add" id="addId" data-toggle="modal" data-target="#commonSmWin"><i class="glyphicon glyphicon-plus icoPaddingLeft"></i>新增</a></li>
                                        <li><a href="javascript:void(0);" id="del_model"><i class="glyphicon glyphicon-trash icoPaddingLeft"></i>批量删除</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="columns btn-group pull-right roleManagementF">
                                <button id="refreshTable" class="btn btn-default" type="button" name="refresh" title="刷新">
                                    <i class="glyphicon glyphicon-refresh icon-refresh"></i>
                                </button>
                                <div class="keep-open btn-group" title="定制显示列">
                                    <button id="customizeColumns" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                        <i class="glyphicon glyphicon-th icon-th"></i> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" role="menu" id="Ul-menu-text">                
                                    </ul>
                                </div>
                            </div>
                        </div>
              <table id="dataTable"
                class="table table-striped table-bordered table-hover checkTable"
                cellspacing="0" width="100%">
                <thead>
                  <tr>
                    <th></th>
                    <th><input
                      type="checkbox" id="checkAll"></th>
                    <th>操作设置</th>
                    <th>角色名称</th>
                    <th>备注</th>
                    <th>权限</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
                
            </div>
          </div>
        </div>
      </div>

  </div>


<!-- Modal -->
    

<div id="commonSmWin" class="modal fade" aria-hidden="true" data-keyboard="false" data-backdrop="static" >
  <div class="modal-dialog" style="max-height: 726px; height: auto;">
    <div class="modal-content"></div>
  </div>
  
</div>
    

{% endblock %}



{% block javascript %}
      {{ block.super }}
      <script>

        (function($,window){
    var $subChk = $("input[name='subChk']");
    var setResource;
    roleList = {
        //初始化
        init: function(){
            //显示隐藏列
            var menu_text = "";
            var table = $("#dataTable tr th:gt(1)");
            menu_text += "<li><label><input type=\"checkbox\" checked=\"checked\" class=\"toggle-vis\" data-column=\"" + parseInt(2) +"\" disabled />"+ table[0].innerHTML +"</label></li>"
            for(var i = 1; i < table.length; i++){
                menu_text += "<li><label><input type=\"checkbox\" checked=\"checked\" class=\"toggle-vis\" data-column=\"" + parseInt(i+2) +"\" />"+ table[i].innerHTML +"</label></li>"
            };
            $("#Ul-menu-text").html(menu_text);
            //表格列定义
            var columnDefs = [ {
                //第一列，用来显示序号
                "searchable" : false,
                "orderable" : false,
                "targets" : 0
            } ];
            var columns = [
                {
                    //第一列，用来显示序号
                    "data" : null,
                    "class" : "text-center"
                },
                {
                    "data" : null,
                    "class" : "text-center",
                    render : function(data, type, row, meta) {
                        var arrayObj = row.id.all;
                        arrayObj.reverse();
                        var idStr = arrayObj.join(",");
                        var result = '';
                        result += '<input  type="checkbox" name="subChk"  value="' + idStr + '" />';
                        return result;
                    }
                },
                {
                    "data" : null,
                    "class" : "text-center", //最后一列，操作按钮
                    render : function(data, type, row, meta) {
                        var arrayObj = row.id.all;
                        var idStr = arrayObj.join(",");
                        var editUrlPath = myTable.editUrl + idStr + ".gsp"; //修改地址
                        var result = '';
                        //修改按钮
                        var isAdminStr = $("#isAdmin").attr("value");
                        var isAdmin = isAdminStr == 'true';
                        if (isAdmin && idStr == 'cn=ROLE_ADMIN,ou=Groups') { // 若为超级管理员，禁用超级管理员角色的修改按钮 
                           result += '<button disabled href="'+editUrlPath+'" data-target="#commonSmWin" data-toggle="modal"  type="button" class="editBtn btn-default deleteButton"><i class="fa fa-ban"></i>修改</button>&nbsp;';
                        }else if (!isAdmin && (idStr == 'cn=ROLE_ADMIN,ou=Groups' || idStr == 'cn=POWER_USER,ou=Groups')) {  // 若为普通管理员，禁用超级管理员角色和普通管理员角色的修改按钮  
                           result += '<button disabled href="'+editUrlPath+'" data-target="#commonSmWin" data-toggle="modal"  type="button" class="editBtn btn-default deleteButton"><i class="fa fa-ban"></i>修改</button>&nbsp;';
                        }else{
                           result += '<button href="'+editUrlPath+'" data-target="#commonSmWin" data-toggle="modal"  type="button" class="editBtn editBtn-info"><i class="fa fa-pencil"></i>修改</button>&nbsp;';
                        }
                        if (data.delFlag == false) { //即刻体验角色不允许删除
                          //删除按钮
                            result += '<button disabled type="button" class="editBtn btn-default deleteButton"><i class="fa fa-ban"></i>删除</button>&nbsp;';
                        } else {
                          //删除按钮
                            result += '<button type="button" onclick="roleList.deleteRole(\''+idStr+'\')" class="deleteButton editBtn disableClick"><i class="fa fa-trash-o"></i>删除</button>';
                        }
                        return result;
                    }
                }, {
                    "data" : "roleName",
                    "class" : "text-center"
                },  {
                    "data" : "description",
                    "class" : "text-center"
                }, {
                    "data" : null,
                    "class" : "text-center", //最后一列，操作按钮
                    render : function(data, type, row, meta) {
                        var arrayObj = row.id.all;
                        var idStr = arrayObj.join(",");
                        return "<a onclick='roleList.showPermission(\"" + idStr
                        + "\")'>预览</a>";
                    }
                }
            ];
            //ajax参数
            var ajaxDataParamFun = function(d) {
                d.simpleQueryParam = $('#simpleQueryParam').val(); //模糊查询
            };
            //表格setting
            var setting = {
                listUrl : '/clbs/c/role/list',
                editUrl : '/clbs/c/role/edit_',
                deleteUrl : '/clbs/c/role/delete_',
                deletemoreUrl : '/clbs/c/role/deletemore',
                enableUrl : '/clbs/c/user/enable_',
                disableUrl : '/clbs/c/user/disable_',
                columnDefs : columnDefs, //表格列定义
                columns : columns, //表格列
                dataTableDiv : 'dataTable', //表格
                ajaxDataParamFun : ajaxDataParamFun, //ajax参数
                pageable : true, //是否分页
                showIndexColumn : true, //是否显示第一列的索引列
                enabledChange : true
            };
            myTable = new TG_Tabel.createNew(setting);
            myTable.init();
            //操作权限 
            setResource = {
                async: {
                    type: "post",
                    enable: true,
                    autoParam: ["id"],
                    dataType: "json"
                },
                check: {
                    enable: true,
                    chkStyle: "checkbox",
                    chkboxType: {
                        "Y": "s",
                        "N": "s"
                    },
                    radioType: "all"
                },
                view: {
                    dblClickExpand: false
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                callback: {
                    beforeClick: roleList.beforeClickResource,
                    onCheck: roleList.onCheckResource
                }
            }
        },
        // 删除角色
        deleteRole: function(id){
            if (id == "cn=ROLE_ADMIN,ou=Groups" || id == "cn=POWER_USER,ou=Groups") {
                layer.msg(roleNoDelete,{move:false});
            }else{
                myTable.deleteItem(id);
            }
        },
        subChk: function(){
            $("#checkAll").prop("checked",$subChk.length == $subChk.filter(":checked").length ? true: false);
        },
        //批量删除
        deleteMuch: function(){
            //判断是否至少选择一项
            var chechedNum = $("input[name='subChk']:checked").length;
            if (chechedNum == 0) {
                layer.msg(selectItem,{move:false});
                return;
            }
            var checkedList = new Array();
            var flag = true;
            $("input[name='subChk']:checked").each(function() {
                if ($(this).val() == "cn=ROLE_ADMIN,ou=Groups" || $(this).val() == "cn=POWER_USER,ou=Groups") {
                    flag = false;
                    return false;
                }else{
                    checkedList.push($(this).val());
                }
            });
            if (flag) {
                myTable.deleteItems({
                    'deltems' : checkedList.join(";")
                });
            }else{
                layer.msg(roleNoDelete,{move:false});
            }
        },
        //点击预览 
        showPermission: function(id){
            $('#showPermissionDiv').modal('show');
            var url="permissionTree";
            var parameter={ "roleId": id};
            json_ajax("POST",url,"json",true,parameter, roleList.showPermissionCallback);
        },
        //返回方法 
        showPermissionCallback: function(data){
            for(var i = 0; i < data.length; i++){
                data[i].chkDisabled = true;     
            }; 
            $.fn.zTree.init($("#resourceDemo"), setResource, data);
            $.fn.zTree.getZTreeObj("resourceDemo").expandAll(false);
        },
        beforeClickResource: function(treeId, treeNode){
            var zTree = $.fn.zTree.getZTreeObj("resourceDemo");
            zTree.checkNode(treeNode, !treeNode.checked, null, true);
            return false;
        },
        onCheckResource: function(e, treeId, treeNode){
            var zTree = $.fn.zTree.getZTreeObj("resourceDemo"), nodes = zTree
                .getCheckedNodes(true), v = "";
            for (var i = 0, l = nodes.length; i < l; i++) {
                v += nodes[i].name + ",";
            }
        },
        //刷新列表
        refreshTable:function(){
          $("#simpleQueryParam").val("");
            myTable.requestData();
        }
    }
    $(function(){
        roleList.init();
        $('input').inputClear();
        //全选
        $("#checkAll").click(function() {
            $("input[name='subChk']").prop("checked", this.checked);
        });
        //单选
        $subChk.on("click",roleList.subChk);
        $("#del_model").on("click",roleList.deleteMuch);
        myTable.add('commonWin', 'permissionForm', null, null);
        $("#refreshTable").on("click",roleList.refreshTable);
    })
})($,window)


        // console.log('stations_list_manger...')
/*<![CDATA[*/
        $(function() {
            var windowId = "commonSmWin";
            $("#" + windowId).on("hidden.bs.modal", function() {
                $(this).removeData("bs.modal");
            });
        });
        /*]]>*/
        

        $('body').on('hidden.bs.modal', '.modal', function () {
            // console.log('hidden??...')
            $(this).removeData('bs.modal');
        });
      </script>
    {% endblock %}

