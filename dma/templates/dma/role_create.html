{% load staticfiles %}

<form id="addForm" role="form" action="{% url 'dma:role_create_manager'  %}" method="post" class="form-horizontal">{% csrf_token %}
    <div class="modal-header">
        <button type="button" id="doXAdd" class="close" data-dismiss="modal"
            aria-hidden="true">&times;</button>
        <h4 class="modal-title">新增角色</h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label class="col-md-3 control-label"><label
                        class="text-danger">*</label> 角色名称： </label>
                    <div class="col-md-7">
                        <input name="roleName" placeholder="请输入角色名称" type="text" 
                            class="form-control" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">备注：</label>
                    <div class="col-md-7">
                        <textarea name="description" rows="4" class="form-control" 
                            placeholder="最多输入140字"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-7">
                        <input id="permissionTree" name="permissionTree" type="text"
                            hidden="true" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label"> 操作权限：</label>
                    <div class="col-md-7">
                        <div class="treeArea">
                            <ul id="permissionDemo" name="fenceTree" class="ztree"></ul>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button id="doSubmitAdd" class="btn btn-primary" type="button">
            <strong>提 交</strong>
        </button>
        <button id="doCloseAdd" type="button" class="btn btn-default" data-dismiss="modal">
            <strong>关 闭</strong>
        </button>
    </div>
</form>

 <link rel="stylesheet" href="{% static 'zTree/css/demo.css' %}" type="text/css">
        <link rel="stylesheet" href="{% static 'zTree/css/zTreeStyle/zTreeStyle.css' %}" type="text/css">
        
<script src="{% static 'hplus-master/js/jquery.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'zTree/js/jquery.ztree.core.js' %}"></script>
        <script type="text/javascript" src="{% static 'zTree/js/jquery.ztree.excheck.js' %}"></script>
<script src="{% static 'virvo/jquery.form.js' %}"></script>
        <script src="{% static 'virvo/jquery.validate.min.js' %}"></script>
        

<script>
    var roleNameNull = "\u89D2\u8272\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A";
    var publicSize20="\u957F\u5EA6\u4E0D\u8D85\u8FC720\u4F4D";
    var publicSize140="\u957F\u5EA6\u4E0D\u8D85\u8FC7140\u4F4D";

    (function($,window){
    var roleAdd = {
        //初始化
        init: function(){
            //操作权限 
            var setpermission = {
                async : {
                    url : "role/choicePermissionTree",
                    type : "get",
                    enable : true,
                    autoParam : [ "id" ],
                    dataType : "json",
                    // data:{'csrfmiddlewaretoken': '{{ csrf_token }}'},
                },
                check : {
                    enable : true,
                    chkStyle : "checkbox",
                    chkboxType : {
                        "Y" : "ps",
                        "N" : "ps"
                    }, 
                    radioType : "all"
                },
                view : {
                    dblClickExpand : false
                },
                data : {
                    simpleData : {
                        enable : true
                    }
                },
                callback : {
                    beforeClick : roleAdd.beforeClickPermission,
                    beforeCheck: roleAdd.zTreeBeforeCheck,
                    onCheck : roleAdd.onCheckPermission
                }
            }
            $.fn.zTree.init($("#permissionDemo"), setpermission, null);
            $(".modal-body").addClass("modal-body-overflow");
        },
        zTreeBeforeCheck: function(treeId, treeNode){
            var flag;
            var zTree = $.fn.zTree.getZTreeObj("permissionDemo");
            if(treeNode.isParent){
                flag = true;
            }else{
                flag = false;
                zTree.checkNode(treeNode, !treeNode.checked, !treeNode.checked);
            };
            return flag;
        },
        beforeClickPermission: function(treeId, treeNode){
            var zTree = $.fn.zTree.getZTreeObj("permissionDemo");
            zTree.checkNode(treeNode, !treeNode.checked, true, true);
            return false;
        },
        onCheckPermission: function(e, treeId, treeNode){
            if(!treeNode.isParent){
                return false;
            };
            var zTree = $.fn.zTree.getZTreeObj("permissionDemo");
            var nodes = zTree.getCheckedNodes(true);
            var v = "";
            for (var i = 0, l = nodes.length; i < l; i++) {
                v += nodes[i].name + ",";
            };
        },
        //提交
        doSubmit: function(){
            var list = [];
            var editlist = [];
            var checkNodes = $.fn.zTree.getZTreeObj("permissionDemo").getCheckedNodes(true);
            if (checkNodes != null && checkNodes.length > 0) {
                for (var i = 0; i < checkNodes.length; i++) {
                    var obj = {};
                    if (checkNodes[i].type == "premissionEdit") { // 可写 
                        editlist.push(checkNodes[i].pId); 
                    }else{
                        obj.id = checkNodes[i].id;
                        obj.edit = false;
                        list.push(obj);
                    }
                }
            }
            // 重组可写的权限 
            if (list.length > 0 && editlist.length >0) {
                for (var i = 0; i < list.length; i++) {
                    for (var j =0; j< editlist.length; j++) {
                        if (list[i].id == editlist[j]) {
                            list[i].edit = true;
                        }
                    }
                }
            }
            
            $("#permissionTree").val(JSON.stringify(list));
            if(roleAdd.validates()){
                var form_options = {
                    target: '#addForm',
                    success: function() { console.log('create success...'); }
                }
                $('#addForm').ajaxForm(form_options);
console.log("vlid submit?");
                // $("#addForm").ajaxSubmit(function(data) {
                //     if (data != null) {
                //         var result = $.parseJSON(data);
                //         if (result.success) {
                //             if (result.obj.flag == 1){
                //                 $("#commonSmWin").modal("hide");
                //                 layer.msg("添加成功！",{move:false});
                //                 myTable.requestData();
                //             }else{
                //                 layer.msg(result.obj.errMsg,{move:false});
                //             }
                //         }else{
                //             layer.msg(result.msg,{move:false});
                //         }
                //     }
                // });
            }
        },
        //校验
        validates: function(){
            return $("#addForm").validate({
                rules : {
                    roleName : {
                        required : true,
                        maxlength : 20
                    },
                    description : {
                        maxlength : 140
                    }
                },
                messages : {
                    roleName : {
                        required : roleNameNull,
                        maxlength : publicSize20
                    },
                    description : {
                        maxlength : publicSize140
                    }
                }
            }).form();
        },
    }
    $(function(){
        roleAdd.init();
        // $('input').inputClear();

        // //优先级策略单选组选择
        // $(".priority-group").on("click","input",function () {
        //     $(".priority-group input").prop("checked",false);
        //     $(this).prop("checked",true)
        // });
        
        $("#doSubmitAdd").on("click",roleAdd.doSubmit);
    })
})($,window)


    // jQuery('.modal-content .calendar').datepicker({ dateFormat: "yy-mm-dd" });


    // var form_options = {
    //     target: '#modal',
    //     success: function() { console.log('create success...'); }
    // }
    // $('#addForm').ajaxForm(form_options);
</script>
